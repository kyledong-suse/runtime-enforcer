suite: "Agent DaemonSet Tests"
templates:
  - "templates/agent/daemonset.yaml"

tests:
  - it: "should allow image, and imagePullPolicy to be overridden"
    set:
      agent:
        agent:
          image:
            repository: somewhere/agent
            tag: v9.9.9
            pullPolicy: Always
    asserts:
      - equal:
          path: "spec.template.spec.containers[0].image"
          value: "somewhere/agent:v9.9.9"
      - equal:
          path: "spec.template.spec.containers[0].imagePullPolicy"
          value: "Always"

  - it: "should include --enable-learning flag when learning is enabled"
    set:
      learning:
        enabled: true
    asserts:
      - contains:
          path: "spec.template.spec.containers[0].args"
          content: "--enable-learning"

  - it: "should not include --enable-learning flag when learning is disabled"
    set:
      learning:
        enabled: false
    asserts:
      - notContains:
          path: "spec.template.spec.containers[0].args"
          content: "--enable-learning"

  - it: "should include grpc port argument"
    set:
      agent:
        agent:
          grpcExporterPort: "12"
    asserts:
      - contains:
          path: "spec.template.spec.containers[0].args"
          content: "--grpc-port=12"

  - it: "check tolerations"
    set:
      agent:
        tolerations:
          - key: "dedicated"
            operator: "Equal"
            value: "experimental"
            effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "dedicated"
            operator: "Equal"
            value: "experimental"
            effect: "NoSchedule"
