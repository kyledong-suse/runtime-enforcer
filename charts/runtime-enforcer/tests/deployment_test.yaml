suite: "Agent DaemonSet Tests"
templates:
  - "templates/operator/deployment.yaml"

tests:
  - it: "should allow image, and imagePullPolicy to be overridden"
    set:
      operator:
        manager:
          replicas: 5
          image:
            repository: somewhere/operator
            tag: v9.9.9
            pullPolicy: Always
    asserts:
      - equal:
          path: "spec.replicas"
          value: 5
      - equal:
          path: "spec.template.spec.containers[0].image"
          value: "somewhere/operator:v9.9.9"
      - equal:
          path: "spec.template.spec.containers[0].imagePullPolicy"
          value: "Always"

  - it: "should include grpc Port argument"
    set:
      agent:
        agent:
          grpcExporterPort: "12"
    asserts:
      - contains:
          path: "spec.template.spec.containers[0].args"
          content: "--wp-status-reconciler-agent-grpc-port=12"

  - it: "should set update interval argument"
    set:
      operator:
        manager:
          wpStatusUpdateInterval: "1s"
    asserts:
      - contains:
          path: "spec.template.spec.containers[0].args"
          content: "--wp-status-reconciler-update-interval=1s"

  - it: "operator should get the correct label selector string"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].args
          content: "--wp-status-reconciler-agent-label-selector=app.kubernetes.io/component=agent,app.kubernetes.io/instance=RELEASE-NAME,app.kubernetes.io/name=runtime-enforcer"

  - it: "check tolerations"
    set:
      operator:
        tolerations:
          - key: "dedicated"
            operator: "Equal"
            value: "experimental"
            effect: "NoSchedule"
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "dedicated"
            operator: "Equal"
            value: "experimental"
            effect: "NoSchedule"
